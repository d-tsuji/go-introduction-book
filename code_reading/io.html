

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>io &#8212; Go言語入門  ドキュメント</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="cob" href="knqyf263/cob/index.html" />
    <link rel="prev" title="Go Note" href="../index.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="knqyf263/cob/index.html" title="cob"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Go Note"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Go言語入門  ドキュメント</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">io</a><ul>
<li><a class="reference internal" href="#io-reader-interface">io.Reader (interface)</a><ul>
<li><a class="reference internal" href="#id2">シグネチャ</a></li>
<li><a class="reference internal" href="#id3">仕様</a></li>
<li><a class="reference internal" href="#id4">実装</a></li>
<li><a class="reference internal" href="#id11">インターフェースを扱う</a></li>
<li><a class="reference internal" href="#io-reader">独自の io.Reader を作る</a></li>
</ul>
</li>
<li><a class="reference internal" href="#io-writer-interface">io.Writer (interface)</a><ul>
<li><a class="reference internal" href="#id12">シグネチャ</a></li>
<li><a class="reference internal" href="#id13">仕様</a></li>
<li><a class="reference internal" href="#id14">実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#io-copy-func">io.Copy (func)</a><ul>
<li><a class="reference internal" href="#id15">仕様</a></li>
<li><a class="reference internal" href="#id16">実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#io-multiwriter-func">io.MultiWriter (func)</a></li>
<li><a class="reference internal" href="#io-pipe-func">io.Pipe (func)</a></li>
<li><a class="reference internal" href="#id17">その他</a></li>
<li><a class="reference internal" href="#id18">参考</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="../index.html"
                        title="前の章へ">Go Note</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="knqyf263/cob/index.html"
                        title="次の章へ">cob</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/code_reading/io.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div><div>
    <h4>Page Info</h4>
    <p>
        <ul>
            <li>英数記号: 1740</li>
            <li>非アスキー: 2106</li>
            <li>合計文字数: 3846</li>
            <li>半角換算: 5952</li>
            <li>全角換算: 2976.0</li>
        </ul>
    </p>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="io">
<h1><a class="toc-backref" href="#id30">io</a><a class="headerlink" href="#io" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>io パッケージの役割は以下の2つ</p>
<ul class="simple">
<li><p>I/Oプリミティブを抽象化する共通のインターフェース(osのファイルディスクリプタのioとか、バッファのioとか)</p></li>
<li><p>関連するI/Oのラッパー</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>必ずしもGroutineセーフではない</p>
</div>
<div class="contents topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#io" id="id30">io</a></p>
<ul>
<li><p><a class="reference internal" href="#io-reader-interface" id="id31">io.Reader (interface)</a></p></li>
<li><p><a class="reference internal" href="#io-writer-interface" id="id32">io.Writer (interface)</a></p></li>
<li><p><a class="reference internal" href="#io-copy-func" id="id33">io.Copy (func)</a></p></li>
<li><p><a class="reference internal" href="#io-multiwriter-func" id="id34">io.MultiWriter (func)</a></p></li>
<li><p><a class="reference internal" href="#io-pipe-func" id="id35">io.Pipe (func)</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id36">その他</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id37">参考</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="io-reader-interface">
<h2><a class="toc-backref" href="#id31">io.Reader (interface)</a><a class="headerlink" href="#io-reader-interface" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id2">
<h3>シグネチャ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>io.Readerは以下のシグネチャを持つReadメソッドを定義しているインターフェースです。<code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">byte[]</span></code> は引数の読み取りした内容を一時的に格納しておくバッファです。</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">io.go</span><a class="headerlink" href="#id19" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Reader</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>ちなみに <code class="docutils literal notranslate"><span class="pre">Read</span></code> は非常にプリミティブなメソッドなので、通常直接このメソッドを扱うことは少なく、ラッパーの高級関数 (<code class="docutils literal notranslate"><span class="pre">ioutil.ReadAll,</span> <span class="pre">ioutil.ReadFile,</span> <span class="pre">bufio.Scanner</span></code>) を使うことが多いのではないでしょうか。</p>
</div>
<div class="section" id="id3">
<h3>仕様<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://godoc.org/io#Reader">GoDoc</a> のパッケージコメントから特徴(想定している仕様)を見てみます。</p>
<ul class="simple">
<li><p>最大 <code class="docutils literal notranslate"><span class="pre">len(p)</span></code> バイトを読み取り、読み取ったバイト数 n とエラーを返却</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;</span> <span class="pre">len(p)</span></code> だったとしてもバッファ p をすべて使っている場合がある</p></li>
<li><p>非nilのエラーを返すか、次の呼び出しでエラーを返す(その時はn=0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">nil)</span></code> を返却することは非推奨。<code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">nil)</span></code> はEOFを示さない。終端まで読んだときは <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">EOF)</span></code> を返す</p></li>
</ul>
<p>要は <strong>バイト列を読み取るためのインターフェース</strong> です。読み取るものは、標準入力でも、ファイルでも、ソケット、バッファでもなんでもよいです。</p>
</div>
<div class="section" id="id4">
<h3>実装<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>例えば <code class="docutils literal notranslate"><span class="pre">os.File</span></code> や <code class="docutils literal notranslate"><span class="pre">bytes.Buffer</span></code> 構造体は <code class="docutils literal notranslate"><span class="pre">Read(p</span> <span class="pre">[]byte)</span> <span class="pre">(n</span> <span class="pre">int,</span> <span class="pre">err</span> <span class="pre">error)</span></code> メソッドを実装しており <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> インターフェースを満たしています。(同時に io.Writer も満たしていることが多い)</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">os/file.go</span><a class="headerlink" href="#id20" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">File</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">file</span> <span class="c1">// os specific</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="c1">// Readメソッドを実装しているので、io.Readerインターフェースを満たしている</span>
<span class="c1">// ファイルから len(b) バイトを読み出す</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">checkValid</span><span class="p">(</span><span class="s">&quot;read&quot;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// 実際の読み込み処理は各OSのファイルのreadに移譲</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">wrapErr</span><span class="p">(</span><span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">bytes/buffer.go</span><a class="headerlink" href="#id21" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Buffer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">buf</span>      <span class="p">[]</span><span class="kt">byte</span> <span class="c1">// データ buf[off : len(buf)] などと参照される</span>
    <span class="nx">off</span>      <span class="kt">int</span>    <span class="c1">// オフセット</span>
    <span class="nx">lastRead</span> <span class="nx">readOp</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="c1">// バッファから len(p) バイト読み出すか、バッファが空になるまで読む</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Buffer</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">lastRead</span> <span class="p">=</span> <span class="nx">opInvalid</span>
    <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Buffer is empty, reset to recover space.</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
    <span class="p">}</span>
    <span class="nx">n</span> <span class="p">=</span> <span class="nb">copy</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">off</span><span class="p">:])</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">off</span> <span class="o">+=</span> <span class="nx">n</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">lastRead</span> <span class="p">=</span> <span class="nx">opRead</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ちなみにメソッドのレシーバがポインタ型(<a href="#id5"><span class="problematic" id="id6">*</span></a>T)だったけど、それで大丈夫？呼び出すときは型 T から呼び出しても大丈夫なの？という疑問があるかも知れません。私はそう思いました。</p>
<p>結論から言うと大丈夫です。というよりもポインタに変換されて呼び出されます。まずGoの仕様として、あるタイプTのポインタ型(<a href="#id7"><span class="problematic" id="id8">*</span></a>T)として宣言されているメソッドは、レシーバ <a href="#id9"><span class="problematic" id="id10">*</span></a>T として宣言されたメソッドと T で宣言されたメソッドを含みます。また型 T の変数 t で宣言されたオブジェクトが t.x() のメソッドを呼び出すときに &amp;t のメソッドとして x が含まれている場合は (&amp;t).x() がGoのコンパイラによって変換されて呼び出されます。</p>
<p><a class="reference external" href="https://golang.org/ref/spec#Method_sets">https://golang.org/ref/spec#Method_sets</a>
<a class="reference external" href="https://golang.org/ref/spec#Calls">https://golang.org/ref/spec#Calls</a></p>
</div>
<p>実際どんな感じで <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> の <code class="docutils literal notranslate"><span class="pre">Read</span></code> メソッドが呼ばれているか <code class="docutils literal notranslate"><span class="pre">ioutil/ioutil.go</span></code> の <code class="docutils literal notranslate"><span class="pre">ReadFile</span></code> メソッドを見てみます。<code class="docutils literal notranslate"><span class="pre">ioutil.ReadFile</span></code> はファイルからデータを読み取るときに使います。</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">ioutil/ioutil.go</span><a class="headerlink" href="#id22" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ファイルからデータを読み出す</span>
<span class="c1">// すべて読んだ場合は EOF error は返さず nil を返す</span>
<span class="kd">func</span> <span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="c1">// ファイルからファイルサイズを取得するが正確でないことがある為</span>
    <span class="c1">// 512 バイトを余分に確保しておく。最低 512 バイト確保される</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int64</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">MinRead</span>

    <span class="k">if</span> <span class="nx">fi</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Stat</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">size</span> <span class="o">:=</span> <span class="nx">fi</span><span class="p">.</span><span class="nx">Size</span><span class="p">()</span> <span class="o">+</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">MinRead</span><span class="p">;</span> <span class="nx">size</span> <span class="p">&gt;</span> <span class="nx">n</span> <span class="p">{</span>
            <span class="nx">n</span> <span class="p">=</span> <span class="nx">size</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">readAll</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="c1">// io.Reader から EOF やエラーになるまでデータを読み取る</span>
<span class="kd">func</span> <span class="nx">readAll</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">capacity</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
    <span class="c1">// バッファオーバーフローした場合のみpanicをrecoverしてbytes.ErrTooLargeのエラーとして返す</span>
    <span class="c1">// それ以外は panic を起こす</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 滅多に見ない recover() 関数</span>
        <span class="nx">e</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">e</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="c1">// panicが発生したエラーの型をチェックして、エラー型だった場合は、値を見て</span>
        <span class="c1">// bytes.ErrTooLarge(&quot;bytes.Buffer: too large&quot;)の場合はエラーとして回復</span>
        <span class="k">if</span> <span class="nx">panicErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="kt">error</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">panicErr</span> <span class="o">==</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">ErrTooLarge</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">panicErr</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">if</span> <span class="nb">int64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">capacity</span><span class="p">))</span> <span class="o">==</span> <span class="nx">capacity</span> <span class="p">{</span>
        <span class="nx">buf</span><span class="p">.</span><span class="nx">Grow</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">capacity</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1">// 内部的には bytes の ReadFrom が呼び出される</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">ReadFrom</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">(),</span> <span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">bytes/buffer.go</span><a class="headerlink" href="#id23" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 最小のバッファサイズ(512バイト)</span>
<span class="kd">const</span> <span class="nx">MinRead</span> <span class="p">=</span> <span class="mi">512</span>

<span class="c1">// io.Reader から EOF までデータを読み取り、バッファに追加する</span>
<span class="c1">// 必要に応じてバッファを拡張する</span>
<span class="c1">// バッファが大きくなりすぎる場合は ErrTooLarge を返す</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Buffer</span><span class="p">)</span> <span class="nx">ReadFrom</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">lastRead</span> <span class="p">=</span> <span class="nx">opInvalid</span>

    <span class="c1">// forループで終了条件 (io.EOF or error) に達するまで処理</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// *Bufferで保持している内部のバッファを割り当てるだけで十分であれば、拡張したスライスを返す</span>
        <span class="c1">// 足りなければ *buffer が保持しているバッファを元の大きさの約2倍に拡張する</span>
        <span class="nx">i</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">grow</span><span class="p">(</span><span class="nx">MinRead</span><span class="p">)</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">i</span><span class="p">]</span>

        <span class="c1">// io.Reader を満たしている構造体の Read メソッドを呼び出す</span>
        <span class="nx">m</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="nb">cap</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nx">m</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="nx">errNegativeRead</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">b</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">i</span><span class="o">+</span><span class="nx">m</span><span class="p">]</span>
        <span class="nx">n</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">e</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="kc">nil</span> <span class="c1">// e is EOF, so return nil explicitly</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">e</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>os.Openやos.Createで生成したos.File構造体はio.Readerを満たしており、Openした変数をそのままioutil.ReadAllに渡せるので、わざわざioutil.ReadFileがあるのはなんでだろうと思います。ファイルの場合は <code class="docutils literal notranslate"><span class="pre">stat()</span></code> などによりおおよそのファイルサイズがわかるため、バッファ領域の確保をより正確にするためと想定しています。</p>
</div>
</div>
<div class="section" id="id11">
<h3>インターフェースを扱う<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>個人的に良い実装だな、と思うのは <code class="docutils literal notranslate"><span class="pre">ReadAll</span></code> のシグネチャが以下のように <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> を受け取るようになっていることです。<code class="docutils literal notranslate"><span class="pre">readAll</span></code> や <code class="docutils literal notranslate"><span class="pre">bytes.ReadFrom</span></code>, <code class="docutils literal notranslate"><span class="pre">bufio.NewReader</span></code> も同様。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">readAll</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">capacity</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ReadFrom</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">rd</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="o">*</span><span class="nx">Reader</span>  <span class="c1">// bufio.Reader も io.Reader を満たしている</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ReadAll</span></code> メソッドは <code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">io.Reader</span></code> とインターフェースを引数に取るようになっています。これによって読み出す対象が何であるか気にする必要がなく <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> インターフェースを満たす構造体であれば何でも受け取ることできます。ファイルを読みたい場合は <code class="docutils literal notranslate"><span class="pre">ReadFile</span></code> のようにラッパーとして実装すればよいだけでOKです。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>インターフェースを使った汎用的なデザインになっているのが良いと思っているのでGo特有というわけではない気がします。JavaだとInterfaceとかAbstractクラスとか使って実装する気がします。</p>
</div>
<p>上記のメソッド/関数の他にも、例えば json を扱う際の <code class="docutils literal notranslate"><span class="pre">json.NewDecoder</span></code> は以下のようになっていますし、独自にI/Oを扱う場合は <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> を受けとるようにすればよいのではないでしょうか。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">NewDecoder</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="o">*</span><span class="nx">Decoder</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Decoder</span><span class="p">{</span><span class="nx">r</span><span class="p">:</span> <span class="nx">r</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="io-reader">
<h3>独自の io.Reader を作る<a class="headerlink" href="#io-reader" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>独自の io.Reader インターフェースを実装した myReader 構造体を作ってみます。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">myReader</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">content</span>  <span class="p">[]</span><span class="kt">byte</span> <span class="c1">// 読み出す対象のバイト列</span>
    <span class="nx">position</span> <span class="kt">int</span>    <span class="c1">// 次に読むオフセット</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">myReader</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">remainingBytes</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="o">-</span> <span class="nx">r</span><span class="p">.</span><span class="nx">position</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">min</span><span class="p">(</span><span class="nx">remainingBytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
    <span class="p">}</span>
    <span class="c1">// copyはビルトイン関数</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">],</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">position</span><span class="p">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">position</span><span class="o">+</span><span class="nx">n</span><span class="p">])</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">position</span> <span class="o">+=</span> <span class="nx">n</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">min</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">a</span> <span class="p">&lt;</span> <span class="nx">b</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">b</span>
<span class="p">}</span>
</pre></div>
</div>
<p>そうすると以下のように <code class="docutils literal notranslate"><span class="pre">ioutil.ReadAll</span></code> にわたすことができます。<code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> インターフェースを満たすだけで、<code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> を受け取る、ありとあらゆる関数を利用することができます。(以下のサンプル実装の場合はうれしみがないですが)</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">reader</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">myReader</span><span class="p">{</span><span class="nx">content</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;this is the stuff I&#39;m reading&quot;</span><span class="p">)}</span>
    <span class="nx">bytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">reader</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">bytes</span><span class="p">))</span>
<span class="p">}</span>
<span class="c1">// this is the stuff I&#39;m reading</span>
</pre></div>
</div>
<p><a class="reference external" href="https://play.golang.org/p/xA1UdgJwwdv">https://play.golang.org/p/xA1UdgJwwdv</a></p>
<hr class="docutils" />
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ちなみにファイル終端の EOF は以下のように実装されていました。たしかに error として定義されています。</p>
<p>var EOF = errors.New(&quot;EOF&quot;)</p>
</div>
</div>
</div>
<div class="section" id="io-writer-interface">
<h2><a class="toc-backref" href="#id32">io.Writer (interface)</a><a class="headerlink" href="#io-writer-interface" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id12">
<h3>シグネチャ<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> も <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> に似ているインターフェースで以下の <code class="docutils literal notranslate"><span class="pre">Write</span></code> メソッドだけを持っているインターフェースです。なので、 <code class="docutils literal notranslate"><span class="pre">Write</span></code> メソッドを満たしていれば <code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> になれます。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Writer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>仕様<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> から <code class="docutils literal notranslate"><span class="pre">len(p)</span></code> バイトを書き込み、書き込んだバイト数とエラーを返却する</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;</span> <span class="pre">len(p)</span></code> の場合は非nilのエラーの返却する必要がある</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> と比較すると仕様がシンプルです。</p>
</div>
<div class="section" id="id14">
<h3>実装<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>インターフェースを満たしている構造体の例を見てみます。例えば <code class="docutils literal notranslate"><span class="pre">os.File</span></code> は以下のように実装しています。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">checkValid</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">n</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrShortWrite</span>
    <span class="p">}</span>

    <span class="nx">epipecheck</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">wrapErr</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また <code class="docutils literal notranslate"><span class="pre">bufio.Buffer</span></code> では以下のように実装しています。</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">bufio/buffer.go</span><a class="headerlink" href="#id24" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Buffer</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">lastRead</span> <span class="p">=</span> <span class="nx">opInvalid</span>
    <span class="nx">m</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tryGrowByReslice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">m</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">grow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">copy</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">m</span><span class="p">:],</span> <span class="nx">p</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>実際どんな感じで <code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> の <code class="docutils literal notranslate"><span class="pre">Write</span></code> メソッドが呼ばれているか見てみます。</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">io/io.go</span><a class="headerlink" href="#id25" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">WriteString</span><span class="p">(</span><span class="nx">w</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">sw</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.(</span><span class="nx">StringWriter</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sw</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 呼び出し元の構造体で実装している Write メソッドを呼び出す</span>
    <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">io/ioutil/ioutil.go</span><a class="headerlink" href="#id26" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">perm</span> <span class="nx">os</span><span class="p">.</span><span class="nx">FileMode</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">,</span> <span class="nx">perm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// os.File構造体のWriteを呼び出す</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrShortWrite</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err1</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">err1</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="io-copy-func">
<h2><a class="toc-backref" href="#id33">io.Copy (func)</a><a class="headerlink" href="#io-copy-func" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>インターフェースではないですが、<code class="docutils literal notranslate"><span class="pre">io.Copy</span></code> も io パッケージの主要なメソッドの一つだと思うので取り上げます。</p>
<div class="section" id="id15">
<h3>仕様<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>src から EOF に到達するかエラーが発生するまで dst にコピー</p></li>
<li><p>コピーしたバイトするとエラーを返す</p></li>
</ul>
</div>
<div class="section" id="id16">
<h3>実装<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">io/io.go</span><a class="headerlink" href="#id27" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">Copy</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">written</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">copyBuffer</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">CopyBuffer</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">Reader</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">written</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">buf</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;empty buffer in io.CopyBuffer&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">copyBuffer</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">copyBuffer</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">Reader</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">written</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If the reader has a WriteTo method, use it to do the copy.</span>
    <span class="c1">// Avoids an allocation and a copy.</span>
    <span class="k">if</span> <span class="nx">wt</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.(</span><span class="nx">WriterTo</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">wt</span><span class="p">.</span><span class="nx">WriteTo</span><span class="p">(</span><span class="nx">dst</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Similarly, if the writer has a ReadFrom method, use it to do the copy.</span>
    <span class="k">if</span> <span class="nx">rt</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">dst</span><span class="p">.(</span><span class="nx">ReaderFrom</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">ReadFrom</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">buf</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// デフォルトでは 32KB をバッファとして確保</span>
        <span class="nx">size</span> <span class="o">:=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">LimitedReader</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">N</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">N</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="nx">size</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">size</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">N</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">nr</span><span class="p">,</span> <span class="nx">er</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">nr</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">nw</span><span class="p">,</span> <span class="nx">ew</span> <span class="o">:=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">nr</span><span class="p">])</span>
            <span class="k">if</span> <span class="nx">nw</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="nx">written</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">nw</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">ew</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">ew</span>
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">nr</span> <span class="o">!=</span> <span class="nx">nw</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrShortWrite</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">er</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">er</span> <span class="o">!=</span> <span class="nx">EOF</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">er</span>
            <span class="p">}</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Go Conference で聞いた高度なテクニックですが、<code class="docutils literal notranslate"><span class="pre">sync.Pool</span></code> でバッファを明示的に指定して io.Copy から io.CopyBuffer にしたところ、メモリ使用量が削減したという話もあります。</p>
<p><a class="reference external" href="https://github.com/src-d/go-git/pull/1179">https://github.com/src-d/go-git/pull/1179</a></p>
<p>どちらかというと sync.Pool の性質(メモリに割り当てられている不要なアイテムをキャッシュし、後で再利用することで、 GC の負荷を下げる)を利用しているテクということだと思います。</p>
</div>
<p>copyするバイト数がわかっていれば、<code class="docutils literal notranslate"><span class="pre">CopyN</span></code> で明示的にコピーするバイト数を指定することもできます。<code class="docutils literal notranslate"><span class="pre">io.Copy</span></code> のラッパー。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">CopyN</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">Reader</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">written</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// LimitReader は src の io.Reader から n バイトだけ読むこむ io.Reader を返却する関数</span>
    <span class="nx">written</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">Copy</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">LimitReader</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">written</span> <span class="o">==</span> <span class="nx">n</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">written</span> <span class="p">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">EOF</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="io-multiwriter-func">
<h2><a class="toc-backref" href="#id34">io.MultiWriter (func)</a><a class="headerlink" href="#io-multiwriter-func" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">io.MultiWriter</span></code> は <code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> のスライスを内部で保持していて、それぞれの <code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> の <code class="docutils literal notranslate"><span class="pre">Write</span></code> メソッドを呼んでいました。デザインパターンでいうところのデコレータパターンらしいです。</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">io/multi.go</span><a class="headerlink" href="#id28" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">MultiWriter</span><span class="p">(</span><span class="nx">writers</span> <span class="o">...</span><span class="nx">Writer</span><span class="p">)</span> <span class="nx">Writer</span> <span class="p">{</span>
    <span class="nx">allWriters</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Writer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">writers</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">writers</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">mw</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.(</span><span class="o">*</span><span class="nx">multiWriter</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">allWriters</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allWriters</span><span class="p">,</span> <span class="nx">mw</span><span class="p">.</span><span class="nx">writers</span><span class="o">...</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">allWriters</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allWriters</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">multiWriter</span><span class="p">{</span><span class="nx">allWriters</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">multiWriter</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">t</span><span class="p">.</span><span class="nx">writers</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrShortWrite</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="io-pipe-func">
<h2><a class="toc-backref" href="#id35">io.Pipe (func)</a><a class="headerlink" href="#io-pipe-func" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>インメモリで io.Writer と io.Reader を同期的につなげるパイプの機能。内部でバッファリング <strong>されない</strong> のが特徴。シーケンシャルに読み書きされる。</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">io/pipe.go</span><a class="headerlink" href="#id29" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">Pipe</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">PipeReader</span><span class="p">,</span> <span class="o">*</span><span class="nx">PipeWriter</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pipe</span><span class="p">{</span>
        <span class="nx">wrCh</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">),</span>
        <span class="nx">rdCh</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">),</span>
        <span class="nx">done</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">PipeReader</span><span class="p">{</span><span class="nx">p</span><span class="p">},</span> <span class="o">&amp;</span><span class="nx">PipeWriter</span><span class="p">{</span><span class="nx">p</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">pipe</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">wrMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// Serializes Write operations</span>
    <span class="nx">wrCh</span> <span class="kd">chan</span> <span class="p">[]</span><span class="kt">byte</span>
    <span class="nx">rdCh</span> <span class="kd">chan</span> <span class="kt">int</span>

    <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span> <span class="c1">// Protects closing done</span>
    <span class="nx">done</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="nx">rerr</span> <span class="nx">atomicError</span>
    <span class="nx">werr</span> <span class="nx">atomicError</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">multiWriter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">writers</span> <span class="p">[]</span><span class="nx">Writer</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PipeWriter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">p</span> <span class="o">*</span><span class="nx">pipe</span>
<span class="p">}</span>

<span class="c1">// 書き込みの処理は pipe に移譲</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">PipeWriter</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pipe</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="c1">// done チャネルがクローズされている場合</span>
    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">p</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">writeCloseError</span><span class="p">()</span>
    <span class="c1">// そうでない場合はmutexでロックを取得</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">wrMu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
        <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">wrMu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// このスコープでの once の役割がよくわからない</span>
    <span class="k">for</span> <span class="nx">once</span> <span class="o">:=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">once</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">once</span> <span class="p">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="c1">// バイトスライスをチャネルに送信</span>
        <span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">wrCh</span> <span class="o">&lt;-</span> <span class="nx">b</span><span class="p">:</span>
            <span class="c1">// reader のチャネルから読み込んだint値を受信</span>
            <span class="nx">nw</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">p</span><span class="p">.</span><span class="nx">rdCh</span>
            <span class="c1">// reader が読み込んだ文字数バイトスライスをすすめる</span>
            <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">nw</span><span class="p">:]</span>
            <span class="nx">n</span> <span class="o">+=</span> <span class="nx">nw</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">p</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">writeCloseError</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 読んだ文字数を返却</span>
    <span class="c1">// n は名前付き変数の戻り値 (参考: https://golang.org/doc/effective_go.html#named-results)</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// クローズした場合はこれが呼ばれる</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pipe</span><span class="p">)</span> <span class="nx">CloseWrite</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">EOF</span>
    <span class="p">}</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">werr</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="c1">// done チャネルのクローズ、sync.Onceなので複数のゴルーチンから同時に呼ばれたとしても一回きりしか呼ばれない</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">once</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nb">close</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">})</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id17">
<h2><a class="toc-backref" href="#id36">その他</a><a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>上記に上げた <code class="docutils literal notranslate"><span class="pre">io.Reader</span></code> や <code class="docutils literal notranslate"><span class="pre">io.Writer</span></code> 以外にも <code class="docutils literal notranslate"><span class="pre">io.Closer</span></code> <code class="docutils literal notranslate"><span class="pre">io.Seeker</span></code> があります。あとは埋め込みのインターフェースやその他の便利な関数などです。割愛します。</p>
</div>
<div class="section" id="id18">
<h2><a class="toc-backref" href="#id37">参考</a><a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/jesseduffield/notes/wiki/Golang-IO-Cookbook">https://github.com/jesseduffield/notes/wiki/Golang-IO-Cookbook</a></p></li>
<li><p><a class="reference external" href="https://medium.com/&#64;matryer/golang-advent-calendar-day-seventeen-io-reader-in-depth-6f744bb4320b">https://medium.com/&#64;matryer/golang-advent-calendar-day-seventeen-io-reader-in-depth-6f744bb4320b</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/ktnyt/items/8ede94469ba8b1399b12">https://qiita.com/ktnyt/items/8ede94469ba8b1399b12</a></p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="knqyf263/cob/index.html" title="cob"
             >次へ</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Go Note"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Go言語入門  ドキュメント</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, tsuji.
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1 で生成しました。
    </div>
  </body>
</html>